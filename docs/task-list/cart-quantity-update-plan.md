# カート画面数量変更機能 実行可能な改修計画  
  
現在のコードベースを調査した結果に基づき、暫定の改修計画タスクリストを提示します。  
  
## 前提：現在の実装状況  
  
### フロントエンド  
- カート画面: [0-cite-0](#0-cite-0)   
- カート状態管理: [0-cite-1](#0-cite-1)   
- ナビゲーションバーのカート数表示: [0-cite-2](#0-cite-2)   
  
### バックエンド（マイクロサービス構成）  
- API Gateway Controller: [0-cite-3](#0-cite-3)   
- Cart Microservice Controller: [0-cite-4](#0-cite-4)   
- Cart Service実装: [0-cite-5](#0-cite-5)   
- Cart Repository: [0-cite-6](#0-cite-6)   
  
### データモデル  
- ShoppingCartエンティティ: [0-cite-7](#0-cite-7)   
- ProductInventoryエンティティ: [0-cite-8](#0-cite-8)   
- テーブル定義: [0-cite-9](#0-cite-9)   
  
---  
  
## Phase 1: 開発タスク  
  
### 1.1 バックエンド開発（cart-microservice）  
  
#### タスク 1.1.1: ShoppingCartRepositoryの拡張  
**目的**: 数量を直接更新するクエリメソッドを追加  
  
**実装内容**:  
- [0-cite-6](#0-cite-6)  に以下を追加：  
  - `updateQuantityDirectly(String userId, String asin, int quantity)` メソッド  
  - `@Query("UPDATE shopping_cart SET quantity = ?3 WHERE user_id = ?1 AND asin = ?2")`  
  - 戻り値: `int`（更新行数）  
  
**工数見積**: 0.5人日  
  
#### タスク 1.1.2: ShoppingCartImplサービスの拡張  
**目的**: 数量更新ビジネスロジックの実装  
  
**実装内容**:  
- [0-cite-5](#0-cite-5)  に以下を追加：  
  - `updateProductQuantity(String userId, String asin, int quantity)` メソッド  
  - バリデーション：quantity >= 1  
  - エラーハンドリング：商品が存在しない場合の処理  
  - 戻り値: 更新後のカート全体（`Map<String, Integer>`）  
  
**工数見積**: 1人日  
  
#### タスク 1.1.3: Cart Microservice Controllerの拡張  
**目的**: 新規エンドポイントの追加  
  
**実装内容**:  
- [0-cite-4](#0-cite-4)  に以下を追加：  
  - `@RequestMapping(method = RequestMethod.POST, value = "/shoppingCart/updateQuantity")`  
  - パラメータ: `@RequestParam("userid") String userId`, `@RequestParam("asin") String asin`, `@RequestParam("quantity") int quantity`  
  - 戻り値: `Map<String, Integer>`（更新後のカート全体）  
  
**工数見積**: 0.5人日  
  
### 1.2 バックエンド開発（api-gateway-microservice）  
  
#### タスク 1.2.1: ShoppingCartRestClientの拡張  
**目的**: Feignクライアントに新メソッド追加  
  
**実装内容**:  
- [0-cite-10](#0-cite-10)  に以下を追加：  
  - `updateProductQuantity(String userId, String asin, int quantity)` メソッド  
  - `@RequestMapping("/cart-microservice/shoppingCart/updateQuantity")`  
  
**工数見積**: 0.5人日  
  
#### タスク 1.2.2: ShoppingCartServiceRestの拡張  
**目的**: サービスインターフェースの拡張  
  
**実装内容**:  
- [0-cite-11](#0-cite-11)  に以下を追加：  
  - `Map<String, Integer> updateProductQuantity(String userId, String asin, int quantity)` メソッド定義  
  
**工数見積**: 0.25人日  
  
#### タスク 1.2.3: ShoppingCartServiceRestImplの拡張  
**目的**: サービス実装の拡張  
  
**実装内容**:  
- [0-cite-12](#0-cite-12)  に以下を追加：  
  - `updateProductQuantity` メソッドの実装  
  - Feignクライアント経由でcart-microserviceを呼び出し  
  
**工数見積**: 0.5人日  
  
#### タスク 1.2.4: API Gateway Controllerの拡張  
**目的**: 公開APIエンドポイントの追加  
  
**実装内容**:  
- [0-cite-3](#0-cite-3)  に以下を追加：  
  - `@RequestMapping(method = RequestMethod.POST, value = "/shoppingCart/updateQuantity")`  
  - パラメータ: `@RequestParam("asin") String asin`, `@RequestParam("quantity") int quantity`  
  - ユーザーID "u1001" をハードコード（既存の実装と同様）  
  - 戻り値: `ResponseEntity<Map<String, Integer>>`  
  
**工数見積**: 0.5人日  
  
### 1.3 在庫チェック機能の実装（オプション：要件に応じて）  
  
#### タスク 1.3.1: Products MicroserviceのAPIエンドポイント確認  
**目的**: 在庫取得用のエンドポイントが存在するか確認・必要に応じて実装  
  
**実装内容**:  
- ProductInventoryServiceを確認: [0-cite-13](#0-cite-13)   
- REST APIエンドポイントが必要な場合は追加実装  
  
**工数見積**: 1人日  
  
#### タスク 1.3.2: Cart Microserviceでの在庫チェック統合  
**目的**: 数量更新時に在庫チェックを実行  
  
**実装内容**:  
- ShoppingCartImplの`updateProductQuantity`メソッドに在庫チェックロジックを追加  
- products-microserviceへの連携（Feign経由）  
- 在庫不足時のエラーハンドリング  
  
**工数見積**: 1.5人日  
  
### 1.4 フロントエンド開発（React）  
  
#### タスク 1.4.1: 数量入力コンポーネントの作成  
**目的**: スピナー（+/-ボタン）+ テキスト入力欄のUIコンポーネント作成  
  
**実装内容**:  
- 新規コンポーネント `QuantityInput.js` を作成  
- Props: `value`, `min`, `max`, `onChange`, `onBlur`, `disabled`, `error`  
- 状態管理: ローカルステート + デバウンス処理  
- バリデーション: 数値チェック、最小値/最大値チェック  
  
**工数見積**: 1.5人日  
  
#### タスク 1.4.2: Cart画面の改修  
**目的**: カート画面に数量変更機能を統合  
  
**実装内容**:  
- [0-cite-14](#0-cite-14)  を以下のように変更：  
  - 価格表示の下に`QuantityInput`コンポーネントを配置  
  - 小計（price × quantity）の表示追加  
  - エラーメッセージ表示エリアの追加  
- 現在の削除ボタンの動作は維持: [0-cite-15](#0-cite-15)   
  
**工数見積**: 1人日  
  
#### タスク 1.4.3: App.jsの改修  
**目的**: 数量更新用のAPI呼び出し関数を追加  
  
**実装内容**:  
- [0-cite-16](#0-cite-16)  に以下を追加：  
  - `updateItemQuantity(product, quantity)` メソッドの実装  
  - `/cart/updateQuantity?asin={asin}&quantity={quantity}` へのPOSTリクエスト  
  - 楽観的UI更新 + エラー時のロールバック  
  - 合計金額の再計算: [0-cite-17](#0-cite-17)   
  
**工数見積**: 1.5人日  
  
#### タスク 1.4.4: 合計金額表示の改善  
**目的**: 数量変更時の視覚的フィードバック  
  
**実装内容**:  
- [0-cite-18](#0-cite-18)  の計算ロジックを使用  
- CSSアニメーション追加（ハイライトエフェクト）  
- [0-cite-19](#0-cite-19)  にスタイルを追加  
  
**工数見積**: 0.5人日  
  
#### タスク 1.4.5: ナビゲーションバーのカート数更新  
**目的**: 数量変更時にヘッダーのカート数を連動更新  
  
**実装内容**:  
- [0-cite-20](#0-cite-20)  の表示はApp.jsのstate経由で自動更新  
- 更新タイミングの確認とテスト  
  
**工数見積**: 0.5人日  
  
### 1.5 エラーハンドリング・バリデーション  
  
#### タスク 1.5.1: バックエンドバリデーションの実装  
**目的**: サーバー側でのデータ整合性チェック  
  
**実装内容**:  
- 数量が1未満の場合のエラー  
- 在庫超過の場合のエラー  
- 商品が存在しない場合のエラー  
- カスタム例外クラスの作成（必要に応じて）  
  
**工数見積**: 1人日  
  
#### タスク 1.5.2: フロントエンドエラーハンドリング  
**目的**: ユーザーフレンドリーなエラー表示  
  
**実装内容**:  
- APIエラーレスポンスの処理  
- インラインエラーメッセージの表示  
- エラー時のロールバック処理  
- 多言語対応（日本語/英語）  
  
**工数見積**: 1人日  
  
---  
  
## Phase 2: テスト（単体テスト）  
  
### 2.1 バックエンド単体テスト  
  
#### タスク 2.1.1: ShoppingCartRepositoryのテスト  
**目的**: データベース操作の正常性確認  
  
**テストケース**:  
1. 正常系: 数量更新が成功すること  
2. 異常系: 存在しない商品の更新で0行が返ること  
3. 境界値: 数量1、数量の最大値でのテスト  
  
**参考**: [0-cite-21](#0-cite-21)   
  
**工数見積**: 1人日  
  
#### タスク 2.1.2: ShoppingCartImplのテスト  
**目的**: ビジネスロジックの正常性確認  
  
**テストケース**:  
1. 正常系: 数量更新が成功すること  
2. 異常系: 数量0以下でエラーが返ること  
3. 異常系: 商品が存在しない場合のエラーハンドリング  
4. 在庫チェック: 在庫を超える数量でエラーが返ること（在庫チェック実装時）  
  
**工数見積**: 1.5人日  
  
#### タスク 2.1.3: Cart Microservice Controllerのテスト  
**目的**: エンドポイントの動作確認  
  
**テストケース**:  
1. 正常系: POSTリクエストで正しいレスポンスが返ること  
2. 異常系: 不正なパラメータでエラーが返ること  
3. HTTPステータスコードの確認  
  
**工数見積**: 1人日  
  
#### タスク 2.1.4: API Gateway Controllerのテスト  
**目的**: 公開APIの動作確認  
  
**テストケース**:  
1. 正常系: エンドポイントが正しく動作すること  
2. Feignクライアント連携の確認（モック使用）  
3. エラーハンドリングの確認  
  
**工数見積**: 1人日  
  
### 2.2 フロントエンド単体テスト  
  
#### タスク 2.2.1: QuantityInputコンポーネントのテスト  
**目的**: UIコンポーネントの動作確認  
  
**テストケース**:  
1. +/-ボタンのクリックで数量が変更されること  
2. テキスト入力で数量が変更されること  
3. 最小値・最大値の制約が機能すること  
4. エラー状態の表示が正しいこと  
  
**工数見積**: 1人日  
  
#### タスク 2.2.2: Cart画面のテスト  
**目的**: カート画面の統合動作確認  
  
**テストケース**:  
1. 数量変更時にAPIが呼び出されること  
2. 小計が正しく計算されること  
3. エラー時にロールバックされること  
4. 削除ボタンが正しく動作すること  
  
**工数見積**: 1.5人日  
  
#### タスク 2.2.3: App.jsのテスト  
**目的**: 状態管理とAPI連携の確認  
  
**テストケース**:  
1. updateItemQuantityメソッドが正しく動作すること  
2. カート合計の計算が正しいこと  
3. エラーハンドリングが正しいこと  
  
**工数見積**: 1人日  
  
### 2.3 統合テスト  
  
#### タスク 2.3.1: E2Eシナリオテスト  
**目的**: エンドツーエンドでの動作確認  
  
**テストシナリオ**:  
1. カート画面で数量を変更し、合計金額が更新されること  
2. 在庫を超える数量を入力するとエラーが表示されること  
3. 数量を1未満にするとエラーが表示されること  
4. ナビゲーションバーのカート数が正しく更新されること  
5. チェックアウト後にカートがクリアされること  
  
**工数見積**: 2人日  
  
---  
  
## Phase 3: 設計書のリバースエンジニアリング  
  
### 3.1 画面設計書の更新  
  
#### タスク 3.1.1: cart.md設計書の更新  
**目的**: カート画面の設計書を最新の実装に合わせて更新  
  
**更新内容**:  
- [0-cite-22](#0-cite-22)  を参考に以下を追加：  
  - 画面項目定義に「数量入力欄」「+ボタン」「-ボタン」「小計表示」を追加  
  - 画面処理設計に数量変更時の処理フローを追加  
  - データマッピングに新規状態変数を追加  
  - 画面レイアウトのスクリーンショット更新  
  
**工数見積**: 1人日  
  
### 3.2 API設計書の作成・更新  
  
#### タスク 3.2.1: API仕様書の作成  
**目的**: 新規エンドポイントのAPI仕様書を作成  
  
**作成内容**:  
- エンドポイント: `POST /api/v1/shoppingCart/updateQuantity`  
- リクエストパラメータ仕様  
- レスポンス仕様  
- エラーレスポンス一覧  
- シーケンス図  
  
**工数見積**: 1人日  
  
### 3.3 データベース設計書の確認  
  
#### タスク 3.3.1: テーブル設計書の確認  
**目的**: 既存のテーブル設計で対応可能か確認  
  
**確認内容**:  
- [0-cite-9](#0-cite-9)  の`shopping_cart`テーブルで対応可能  
- バージョン管理カラム追加の必要性検討（楽観的ロック用）  
- 必要に応じてテーブル設計書を更新  
  
**工数見積**: 0.5人日  
  
### 3.4 シーケンス図・アーキテクチャ図の作成  
  
#### タスク 3.4.1: シーケンス図の作成  
**目的**: 数量変更処理のフローを可視化  
  
**作成内容**:  
1. 正常系シーケンス図  
   - React → API Gateway → Cart Microservice → YSQL  
2. 在庫チェック付きシーケンス図（在庫チェック実装時）  
   - Cart Microservice → Products Microservice → YCQL  
  
**工数見積**: 1人日  
  
#### タスク 3.4.2: コンポーネント図の更新  
**目的**: 新規コンポーネントを反映したアーキテクチャ図の作成  
  
**作成内容**:  
- QuantityInputコンポーネントの追加  
- API呼び出しフローの追加  
- マイクロサービス間の連携図  
  
**工数見積**: 0.5人日  
  
---  
  
## 工数サマリー  
  
| フェーズ | カテゴリ | 工数（人日） |  
|---------|---------|-------------|  
| Phase 1 | バックエンド開発（cart-microservice） | 2.0 |  
| Phase 1 | バックエンド開発（api-gateway-microservice） | 1.75 |  
| Phase 1 | 在庫チェック機能（オプション） | 2.5 |  
| Phase 1 | フロントエンド開発 | 5.0 |  
| Phase 1 | エラーハンドリング | 2.0 |  
| Phase 2 | バックエンド単体テスト | 4.5 |  
| Phase 2 | フロントエンド単体テスト | 3.5 |  
| Phase 2 | 統合テスト | 2.0 |  
| Phase 3 | 設計書作成・更新 | 4.0 |  
| **合計** | | **27.25人日** |  
  
※在庫チェック機能を実装しない場合: **24.75人日**  
  
---  
  
## Notes  
  
### 実装上の重要ポイント  
  
1. **マイクロサービスアーキテクチャの考慮**  
   - API Gateway経由で3層構造（React → API Gateway → Cart Microservice）  
   - Feignクライアントを使用したマイクロサービス間通信: [0-cite-10](#0-cite-10)   
  
2. **既存機能との整合性**  
   - 削除ボタンの動作は変更しない: [0-cite-23](#0-cite-23)   
   - 既存のaddProduct/removeProductエンドポイントは後方互換性のため維持  
  
3. **ユーザーID管理**  
   - 現在はユーザーID "u1001" がハードコード: [0-cite-24](#0-cite-24)   
   - 本番環境では認証・認可機構の実装が必要  
  
4. **データベースAPI**  
   - cart-microserviceはYSQL (PostgreSQL互換) を使用: [0-cite-25](#0-cite-25)   
   - products-microserviceはYCQL (Cassandra互換) を使用: [0-cite-26](#0-cite-26)   
  
5. **在庫チェック実装時の追加作業**  
   - ProductInventoryServiceは既に存在: [0-cite-13](#0-cite-13)   
   - マイクロサービス間連携のため、APIゲートウェイ経由での在庫取得APIが必要  
  
この計画は、現在のコードベースの構造を最大限活用し、既存機能への影響を最小限に抑えた設計となっています。
